<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anonymous Chat - Admin Control</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .chat-container {
      width: 100%;
      max-width: 800px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }

    .header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.5rem;
    }

    .admin-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    .admin-btn:hover {
      background: #c0392b;
    }

    .admin-btn.admin-active {
      background: #27ae60;
    }

    .admin-panel {
      background: #34495e;
      color: white;
      padding: 15px;
      display: none;
    }

    .admin-panel.active {
      display: block;
    }

    .admin-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .admin-controls button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
    }

    .export-btn {
      background: #3498db;
      color: white;
    }

    .logout-btn {
      background: #95a5a6;
      color: white;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .message {
      background: white;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
      position: relative;
    }

    .message.deleted {
      opacity: 0.6;
      border-left-color: #e74c3c;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .username {
      font-weight: bold;
      color: #2c3e50;
    }

    .timestamp {
      color: #7f8c8d;
      font-size: 0.8rem;
    }

    .message-content {
      color: #2c3e50;
      word-break: break-word;
    }

    .delete-msg-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .message:hover .delete-msg-btn {
      opacity: 1;
    }

    .input-area {
      padding: 20px;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }

    #messageInput:focus {
      border-color: #3498db;
    }

    #sendBtn {
      background: #3498db;
      color: white;
      border: none;
      padding: 0 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    #sendBtn:hover {
      background: #2980b9;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: #2ecc71;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
    }

    .notification.error {
      background: #e74c3c;
    }

    .notification.warning {
      background: #f39c12;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }

    .modal input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .modal button {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .online-count {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .char-count {
      font-size: 0.8rem;
      color: #7f8c8d;
      text-align: right;
      margin-top: 5px;
    }

    @media (max-width: 600px) {
      .chat-container {
        height: 95vh;
      }
      
      .header {
        flex-direction: column;
        gap: 10px;
      }
      
      .input-area {
        flex-direction: column;
      }
      
      #sendBtn {
        width: 100%;
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <!-- Admin Login Modal -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h2>Admin Login</h2>
      <input type="text" id="adminUsername" placeholder="Username" autocomplete="off">
      <input type="password" id="adminPassword" placeholder="Password" autocomplete="off">
      <button id="loginBtn">Login</button>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1>Anonymous Chat ðŸ’¬</h1>
        <div class="online-count">Online: <span id="onlineCount">1</span></div>
      </div>
      <button id="adminAccessBtn" class="admin-btn">
        <i class="fas fa-shield-alt"></i> Admin
      </button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
      <div>
        <strong>Admin Panel</strong> | Logged in as: <span id="adminName">Not logged in</span>
      </div>
      <div class="admin-controls">
        <button id="clearAllBtn" class="delete-btn">
          <i class="fas fa-trash"></i> Clear All Messages
        </button>
        <button id="refreshBtn" class="export-btn">
          <i class="fas fa-sync"></i> Refresh
        </button>
        <button id="logoutAdminBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" id="messagesContainer">
      <!-- Messages will appear here -->
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
      <button id="sendBtn">Send</button>
    </div>
    <div class="char-count">
      <span id="charCount">0</span>/500 characters
    </div>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = "https://dwivklunuucddhbnzmbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3aXZrbHVudXVjZGRoYm56bWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTU4NDEsImV4cCI6MjA3NTIzMTg0MX0.Rj800uYlaO4TtV6TA_ThUoHhhQy55E2A9boADLStuUI";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // App State
    let userId = localStorage.getItem('anon_id');
    let isAdmin = localStorage.getItem('is_admin') === 'true';
    let lastMessageTime = 0;
    const MESSAGE_COOLDOWN = 3000; // 3 seconds

    // DOM Elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const adminAccessBtn = document.getElementById('adminAccessBtn');
    const adminPanel = document.getElementById('adminPanel');
    const adminModal = document.getElementById('adminModal');
    const adminUsernameInput = document.getElementById('adminUsername');
    const adminPasswordInput = document.getElementById('adminPassword');
    const loginBtn = document.getElementById('loginBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutAdminBtn = document.getElementById('logoutAdminBtn');
    const notification = document.getElementById('notification');
    const charCount = document.getElementById('charCount');
    const onlineCount = document.getElementById('onlineCount');
    const adminName = document.getElementById('adminName');

    // Generate User ID
    if (!userId) {
      const randomId = Math.floor(10000 + Math.random() * 90000);
      userId = `Anonymous#${randomId}`;
      localStorage.setItem('anon_id', userId);
    }

    // Admin Credentials
    const ADMIN_CREDENTIALS = {
      username: 'fwrobby',
      password: 'm.asim12'
    };

    // Initialize
    function init() {
      updateAdminUI();
      loadMessages();
      setupEventListeners();
      setupRealtimeSubscription();
    }

    // Update Admin UI
    function updateAdminUI() {
      if (isAdmin) {
        adminAccessBtn.classList.add('admin-active');
        adminAccessBtn.innerHTML = '<i class="fas fa-crown"></i> Admin Mode';
        adminPanel.classList.add('active');
        adminName.textContent = ADMIN_CREDENTIALS.username;
      } else {
        adminAccessBtn.classList.remove('admin-active');
        adminAccessBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Admin';
        adminPanel.classList.remove('active');
        adminName.textContent = 'Not logged in';
      }
    }

    // Show Notification
    function showNotification(message, type = 'success') {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Format Time
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Display Message
    function displayMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.dataset.id = message.id;
      
      if (message.deleted) {
        messageDiv.classList.add('deleted');
      }

      const isOwnMessage = message.user_id === userId;
      
      messageDiv.innerHTML = `
        <div class="message-header">
          <span class="username">${isOwnMessage ? 'You' : message.user_id}</span>
          <span class="timestamp">${formatTime(message.created_at)}</span>
        </div>
        <div class="message-content">${message.deleted ? '[Message deleted]' : message.content}</div>
        ${(isAdmin || isOwnMessage) && !message.deleted ? 
          `<button class="delete-msg-btn" onclick="deleteMessage(${message.id})">
            <i class="fas fa-trash"></i>
          </button>` : ''
        }
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Load Messages
    async function loadMessages() {
      try {
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .order('created_at', { ascending: true });

        if (error) throw error;

        messagesContainer.innerHTML = '';
        data.forEach(displayMessage);
      } catch (error) {
        console.error('Error loading messages:', error);
        showNotification('Failed to load messages', 'error');
      }
    }

    // Send Message
    async function sendMessage() {
      const content = messageInput.value.trim();
      
      if (!content) {
        showNotification('Message cannot be empty', 'warning');
        return;
      }

      const now = Date.now();
      if (now - lastMessageTime < MESSAGE_COOLDOWN) {
        showNotification(`Please wait ${MESSAGE_COOLDOWN/1000} seconds between messages`, 'warning');
        return;
      }

      if (content.length > 500) {
        showNotification('Message too long (max 500 characters)', 'warning');
        return;
      }

      try {
        const { error } = await supabase
          .from('messages')
          .insert([
            {
              user_id: userId,
              content: content,
              created_at: new Date().toISOString(),
              deleted: false
            }
          ]);

        if (error) throw error;

        messageInput.value = '';
        charCount.textContent = '0';
        lastMessageTime = now;
        showNotification('Message sent!');
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Failed to send message', 'error');
      }
    }

    // Delete Message (Admin or own)
    async function deleteMessage(messageId) {
      if (!confirm('Are you sure you want to delete this message?')) return;

      try {
        // For admin, we can use direct delete
        // For regular users, we should mark as deleted (soft delete)
        if (isAdmin) {
          const { error } = await supabase
            .from('messages')
            .delete()
            .eq('id', messageId);

          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('messages')
            .update({ deleted: true })
            .eq('id', messageId)
            .eq('user_id', userId);

          if (error) throw error;
        }

        showNotification('Message deleted');
      } catch (error) {
        console.error('Error deleting message:', error);
        showNotification('Failed to delete message', 'error');
      }
    }

    // Clear All Messages (Admin only)
    async function clearAllMessages() {
      if (!isAdmin) {
        showNotification('Admin access required', 'error');
        return;
      }

      if (!confirm('âš ï¸ DANGER: This will delete ALL messages permanently! Continue?')) return;

      try {
        const { error } = await supabase
          .from('messages')
          .delete()
          .neq('id', 0); // Delete all messages

        if (error) throw error;

        showNotification('All messages cleared');
        loadMessages();
      } catch (error) {
        console.error('Error clearing messages:', error);
        showNotification('Failed to clear messages', 'error');
      }
    }

    // Setup Realtime Subscription
    function setupRealtimeSubscription() {
      supabase
        .channel('messages')
        .on('postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'messages' },
          (payload) => {
            displayMessage(payload.new);
          }
        )
        .on('postgres_changes',
          { event: 'DELETE', schema: 'public', table: 'messages' },
          (payload) => {
            const messageDiv = document.querySelector(`[data-id="${payload.old.id}"]`);
            if (messageDiv) {
              messageDiv.classList.add('deleted');
              messageDiv.querySelector('.message-content').textContent = '[Message deleted]';
            }
          }
        )
        .on('postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'messages' },
          (payload) => {
            const messageDiv = document.querySelector(`[data-id="${payload.new.id}"]`);
            if (messageDiv) {
              if (payload.new.deleted) {
                messageDiv.classList.add('deleted');
                messageDiv.querySelector('.message-content').textContent = '[Message deleted]';
              }
            }
          }
        )
        .subscribe();
    }

    // Setup Event Listeners
    function setupEventListeners() {
      // Send message
      sendBtn.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Character count
      messageInput.addEventListener('input', () => {
        charCount.textContent = messageInput.value.length;
      });

      // Admin access
      adminAccessBtn.addEventListener('click', () => {
        if (isAdmin) {
          // Toggle admin panel
          adminPanel.classList.toggle('active');
        } else {
          // Show login modal
          adminModal.style.display = 'flex';
          adminUsernameInput.focus();
        }
      });

      // Admin login
      loginBtn.addEventListener('click', () => {
        const username = adminUsernameInput.value.trim();
        const password = adminPasswordInput.value.trim();

        if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
          isAdmin = true;
          localStorage.setItem('is_admin', 'true');
          adminModal.style.display = 'none';
          updateAdminUI();
          showNotification('Admin login successful!');
          
          // Clear inputs
          adminUsernameInput.value = '';
          adminPasswordInput.value = '';
        } else {
          showNotification('Invalid credentials', 'error');
        }
      });

      // Clear all messages
      clearAllBtn.addEventListener('click', clearAllMessages);

      // Refresh messages
      refreshBtn.addEventListener('click', loadMessages);

      // Logout admin
      logoutAdminBtn.addEventListener('click', () => {
        isAdmin = false;
        localStorage.removeItem('is_admin');
        updateAdminUI();
        showNotification('Logged out from admin');
      });

      // Close modal on outside click
      adminModal.addEventListener('click', (e) => {
        if (e.target === adminModal) {
          adminModal.style.display = 'none';
        }
      });

      // Close modal with escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          adminModal.style.display = 'none';
        }
      });
    }

    // Export chat (optional feature)
    async function exportChat() {
      try {
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .order('created_at', { ascending: true });

        if (error) throw error;

        const exportData = {
          exportedAt: new Date().toISOString(),
          totalMessages: data.length,
          messages: data
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showNotification('Chat exported successfully!');
      } catch (error) {
        console.error('Error exporting chat:', error);
        showNotification('Failed to export chat', 'error');
      }
    }

    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', init);

    // Make deleteMessage function available globally for onclick handlers
    window.deleteMessage = deleteMessage;
    window.exportChat = exportChat; // Optional: Add export button if needed
  </script>
</body>
</html>