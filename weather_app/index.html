<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather App</title>

  <!-- Tab image (Studio Project) -->
  <link rel="icon" type="image/png" href="/Studio-Project.png">
  <link rel="apple-touch-icon" href="/Studio-Project.png">

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="wrap">
    <section class="card" aria-labelledby="title">
      <h1 id="title" class="app-title">Weather App</h1>

      <div class="controls">
        <input id="cityInput" type="text" placeholder="Enter city name (e.g. Sukho)" aria-label="City name">

        <div class="buttons-row">
          <button id="getBtn" class="btn btn-primary">Get Weather</button>
          <button id="locBtn" class="btn btn-secondary">Check my location</button>
        </div>
      </div>

      <div id="result" class="result" aria-live="polite"></div>

    </section>

    <!-- credits outside the card, with a thin non-touching line + text below -->
    <div class="credits-wrap">
      <hr class="credits-line">
      <div class="credits-text">Made by Muhammad Asim (Robby)</div>
    </div>

    <!-- Unit toggle placed after result (hidden until results exist) -->
    <div id="unitContainer" class="unit-container hidden">
      <button id="unitBtn" class="btn btn-ghost">Show °F</button>
    </div>
  </main>

  <script>
    // ---------- CONFIG ----------
    const API_KEY = "cef868c24f7eadea4f39779c0e588c9b";
    let useCelsius = true;
    let lastWeather = null;

    // ---------- DOM ----------
    const cityInput = document.getElementById('cityInput');
    const getBtn = document.getElementById('getBtn');
    const locBtn = document.getElementById('locBtn');
    const unitBtn = document.getElementById('unitBtn');
    const unitContainer = document.getElementById('unitContainer');
    const resultDiv = document.getElementById('result');

    // ---------- EVENTS ----------
    getBtn.addEventListener('click', () => getWeather());
    locBtn.addEventListener('click', () => getLocationWeather());
    cityInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') getWeather(); });
    // unit button toggles and only shown after a successful fetch
    unitBtn && unitBtn.addEventListener('click', toggleUnit);

    // ---------- HELPERS ----------
    function showLoading() {
      resultDiv.innerHTML = '<div class="spinner" aria-hidden="true"></div><div class="small">Loading weather…</div>';
      hideUnit();
    }
    function showMessage(msg) {
      resultDiv.innerHTML = '<div class="msg">' + escapeHtml(msg) + '</div>';
      hideUnit();
    }
    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // load image with timeout fallback (helps show icon on first try)
    function loadImageWithTimeout(url, timeoutMs = 1500) {
      return new Promise((resolve) => {
        const img = new Image();
        let settled = false;
        const timer = setTimeout(() => {
          if (!settled) { settled = true; resolve(false); }
        }, timeoutMs);
        img.onload = () => { if (!settled) { settled = true; clearTimeout(timer); resolve(true); } };
        img.onerror = () => { if (!settled) { settled = true; clearTimeout(timer); resolve(false); } };
        img.src = url;
      });
    }

    // ---------- FETCH / RENDER ----------
    async function getWeather(city = null, lat = null, lon = null) {
      if (!city && (typeof lat !== 'number' || typeof lon !== 'number')) {
        const typed = cityInput.value && cityInput.value.trim();
        if (!typed) { showMessage('Please enter a city name.'); return; }
        city = typed;
      }

      let url;
      if (typeof lat === 'number' && typeof lon === 'number') {
        url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
      } else {
        url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${API_KEY}&units=metric`;
      }

      try {
        showLoading();
        const resp = await fetch(url);
        if (!resp.ok) {
          if (resp.status === 404) throw new Error('City not found.');
          throw new Error('Unable to fetch weather.');
        }
        const data = await resp.json();
        lastWeather = data;
        await renderWeather(data);
      } catch (err) {
        showMessage(err.message || 'Error fetching weather.');
      }
    }

    async function getLocationWeather() {
      if (!navigator.geolocation) { showMessage('Geolocation not supported by your browser.'); return; }
      showLoading();
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude: lat, longitude: lon } = pos.coords;
        await getWeather(null, lat, lon);
      }, () => {
        showMessage('Location access denied.');
      }, { timeout: 10000 });
    }

    async function renderWeather(data) {
      // Ensure safe icon handling: some responses may not include weather[0] — use default '03d'
      const weatherItem = (data.weather && data.weather[0]) ? data.weather[0] : { description: 'N/A', icon: '03d' };
      const iconCode = weatherItem.icon || '03d';
      const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;

      // Preload icon for first-click reliability
      const iconLoaded = await loadImageWithTimeout(iconUrl, 1500);

      // compute temperature and local time
      const tempC = typeof data.main?.temp === 'number' ? data.main.temp : 0;
      const temp = useCelsius ? tempC : (tempC * 9/5) + 32;
      const unit = useCelsius ? '°C' : '°F';
      const localDate = new Date((data.dt + (data.timezone || 0)) * 1000);
      const localStr = localDate.toLocaleString([], { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

      // Prepare icon HTML (fallback inline SVG if load fails)
      const iconHtml = iconLoaded
        ? `<img class="weather-icon" src="${iconUrl}" alt="${escapeHtml(weatherItem.description)}">`
        : `<svg class="weather-icon fallback" viewBox="0 0 24 24" aria-hidden="true" width="76" height="76"><path fill="currentColor" d="M19.36 10.46A7 7 0 0 0 5 10.5a5 5 0 0 0 .22 9.98h13.14a4 4 0 0 0 .99-7.02z"/></svg>`;

      // Fill result
      resultDiv.innerHTML = `
        <div class="top">
          ${iconHtml}
          <div class="city-block">
            <div class="city-name">${escapeHtml(data.name || 'Unknown')}</div>
            <div class="country">${escapeHtml(data.sys?.country || '')}</div>
          </div>
        </div>

        <div class="grid">
          <div class="grid-item">
            <div class="label">Temperature</div>
            <div class="value">${temp.toFixed(1)} ${unit}</div>
          </div>
          <div class="grid-item">
            <div class="label">Condition</div>
            <div class="value">${escapeHtml(capitalize(weatherItem.description || 'N/A'))}</div>
          </div>
          <div class="grid-item">
            <div class="label">Humidity</div>
            <div class="value">${data.main?.humidity ?? 'N/A'}%</div>
          </div>
          <div class="grid-item">
            <div class="label">Local time</div>
            <div class="value">${localStr}</div>
          </div>
        </div>
      `;

      // Show unit toggle below result
      showUnit();
    }

    function toggleUnit() {
      useCelsius = !useCelsius;
      unitBtn.textContent = useCelsius ? 'Show °F' : 'Show °C';
      if (lastWeather) renderWeather(lastWeather);
    }

    function showUnit() {
      unitContainer.classList.remove('hidden');
    }

    function hideUnit() {
      unitContainer.classList.add('hidden');
    }

    function capitalize(s) { if (!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }

    // focus input on load
    window.addEventListener('load', () => cityInput.focus());
  </script>
</body>
</html>
